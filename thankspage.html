<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ご注文ありがとうございました</title>
  <link rel="stylesheet" href="css/style.css">
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-4Y6LTF5EQM"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-4Y6LTF5EQM', { 'debug_mode':true });
  </script>
</head>
<body>
  <h1>ご注文ありがとうございます！</h1>
  <p>ご注文が正常に完了しました。</p>
  <a href="index.html">トップページに戻る</a>

  <!-- thankyou.html の <body> の最後に追加 -->
  <script>
    const cart = JSON.parse(localStorage.getItem('cart')) || {};
    const transactionId = 'T' + Date.now();

    fetch('/ec-site/data/products.json')
    .then(res => res.json())
    .then(products => {
      let totalValue = 0;
      const items = [];

      Object.keys(cart).forEach(productId => {
        const product = products.find(p => p.id === productId);
        if (product) {
          const quantity = cart[productId];
          const price = product.price;
          const subtotal = price * quantity;
          totalValue += subtotal;

          items.push({
            item_id: product.id,
            item_name: product.name,
            quantity: quantity,
            price: Number(product.price),
            currency: 'JPY',
          });
        }
      });

      if (window.gtag && items.length > 0) {
        gtag('event', 'purchase', {
          transaction_id: transactionId,
          value: totalValue,
          currency: 'JPY',
          items: items,
        });
      }

      localStorage.removeItem('cart');
    });
    const customer = JSON.parse(localStorage.getItem('customer'));

    if (customer && window.gtag) {
    // メールアドレスではなく、自動生成された user_id を送信
    gtag('config', 'G-4Y6LTF5EQM', {
    user_id: customer.user_id
    });

    // 属性情報も user_properties で送信
    gtag('set', 'user_properties', {
    name: customer.name,
    pref: customer.address.split(' ')[1] || '',
    delivery_date: customer.delivery_date || '指定なし'
    });
    }
  </script>
</body>
</html>